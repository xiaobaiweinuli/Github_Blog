<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>认证中...</title>
</head>
<body>
    <script>
        (async () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if (!code) {
                alert('无效的认证请求');
                window.location.href = '/Github_Blog/login.html';
                return;
            }

            try {
                // 获取Access Token
                const tokenRes = await fetch('https://github.com/login/oauth/access_token', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: import.meta.env.VITE_GH_CLIENT_ID,
                        client_secret: import.meta.env.VITE_GH_CLIENT_SECRET,
                        code: code
                    })
                });
                
                const tokenData = await tokenRes.json();
                if (!tokenData.access_token) throw new Error('获取Token失败');

                // 验证用户身份
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
                });
                
                const userData = await userRes.json();
                if (userData.login !== 'YOUR_GITHUB_USERNAME') throw new Error('无访问权限');

                // 存储认证信息
                localStorage.setItem('gh_auth', JSON.stringify({
                    token: tokenData.access_token,
                    expires: Date.now() + 3600000 // 1小时有效期
                }));
                
                window.location.href = '/Github_Blog/admin.html';
            } catch (error) {
                console.error('认证失败:', error);
                alert('认证失败: ' + error.message);
                window.location.href = '/Github_Blog/login.html';
            }
        })();
    </script>
</body>
</html>
