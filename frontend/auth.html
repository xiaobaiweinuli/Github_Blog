<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>认证中...</title>
    <!-- 定义全局环境变量 -->
    
</head>
<body>
    <script type="module">
        (async () => {
            const code = new URLSearchParams(window.location.search).get('code');
            if (!code) {
                alert('无效的认证请求');
                window.location.href = '/Github_Blog/login.html';
                return;
            }

            try {
                // 检查环境变量是否正确定义
                if (!import.meta.env.VITE_GH_CLIENT_ID || !import.meta.env.VITE_GH_CLIENT_SECRET) {
                    throw new Error('环境变量未正确定义，请检查登录页面');
                }
                
                // 获取Access Token
                const workersUrl = 'https://github-oauth-proxy.bxiao.workers.dev'; // 实际的Workers URL
            const state = crypto.randomUUID();
                document.cookie = `gh_auth_state=${state}; path=/; max-age=3600`;
                const tokenRes = await fetch(`${workersUrl}/auth/token?state=${state}`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            });

            if (tokenRes.status !== 200) {
                const errorData = await tokenRes.json();
                throw new Error(`认证失败: ${errorData.error || tokenRes.statusText} (状态码: ${tokenRes.status})`);
            }

            const tokenData = await tokenRes.json();
                if (!tokenData.access_token) throw new Error('获取Token失败');

                // 验证用户身份
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `Bearer ${tokenData.access_token}` }
                });
                
                const userData = await userRes.json();
                const savedState = document.cookie.split('; ').find(row => row.startsWith('gh_auth_state='))?.split('=')[1];
                if (state !== savedState) throw new Error('无效的state参数');
                if (userData.login !== 'YOUR_GITHUB_USERNAME') throw new Error('无访问权限');

                // 存储认证信息
                localStorage.setItem('gh_auth', JSON.stringify({
                    token: tokenData.access_token,
                    expires: Date.now() + 3600000 // 1小时有效期
                }));
                
                window.location.href = '/Github_Blog/admin.html';
            } catch (error) {
                console.error('认证失败:', error);
                alert('认证失败: ' + error.message);
                window.location.href = '/Github_Blog/login.html';
            }
        })();
    </script>
</body>
</html>